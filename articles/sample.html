<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fast sampling methods • dqrng</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fast sampling methods">
<meta property="og:description" content="dqrng">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dqrng</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dqrng.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cpp-api.html">C++ API</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallel RNG usage</a>
    </li>
    <li>
      <a href="../articles/sample.html">Fast sampling methods</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daqana/dqrng/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fast sampling methods</h1>
                        <h4 data-toc-skip class="author">Ralf
Stubner</h4>
            
            <h4 data-toc-skip class="date">2023-08-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/daqana/dqrng/blob/HEAD/vignettes/sample.Rmd" class="external-link"><code>vignettes/sample.Rmd</code></a></small>
      <div class="hidden name"><code>sample.Rmd</code></div>

    </div>

    
    
<p>Random sampling from a fixed set is used in many areas of statistical
computing. The performance of this operation can be critical, especially
when the sampled set is large. The fast RNGs provided in this package
make very fast sampling possible when combined with suitably fast
algorithms.</p>
<div class="section level2">
<h2 id="benchmarks">Benchmarks<a class="anchor" aria-label="anchor" href="#benchmarks"></a>
</h2>
<p>By combining fast RNGs with a fast methods for creating <a href="http://www.pcg-random.org/posts/bounded-rands.html" class="external-link">integers in a
range</a> one gets good performance for sampling with replacement:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">*</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="fl">1e4</span><span class="op">*</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="48%">
<col width="14%">
<col width="14%">
<col width="11%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n, replace = TRUE)</td>
<td align="right">4.332840e-04</td>
<td align="right">4.750484e-04</td>
<td align="right">1999.342</td>
<td align="right">50288</td>
</tr>
<tr class="even">
<td align="left">sample.int(10000 * m, n, replace = TRUE)</td>
<td align="right">8.460152e-04</td>
<td align="right">9.003752e-04</td>
<td align="right">1072.688</td>
<td align="right">82600</td>
</tr>
<tr class="odd">
<td align="left">dqsample.int(m, n, replace = TRUE)</td>
<td align="right">4.761992e-05</td>
<td align="right">5.002553e-05</td>
<td align="right">17170.274</td>
<td align="right">59592</td>
</tr>
<tr class="even">
<td align="left">dqsample.int(10000 * m, n, replace = TRUE)</td>
<td align="right">5.327608e-05</td>
<td align="right">5.754706e-05</td>
<td align="right">14311.590</td>
<td align="right">84848</td>
</tr>
</tbody>
</table>
<p>Note that sampling from <code>10^10</code> integers triggers “<a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/LongVectors.html" class="external-link">long-vector
support</a>” in R.</p>
<p>When sampling <em>without</em> replacement one has to consider an
appropriate algorithm for making sure that no entry is repeated. When
more than 50% of the population are sampled, dqrng shuffles an
appropriate part of the full list and returns that. The algorithm used
in R is similar but dqrng has the edge with respect to performance:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">6e5</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span>, min_iterations <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n)</td>
<td align="right">0.05595910</td>
<td align="right">0.06371229</td>
<td align="right">15.45168</td>
<td align="right">6402656</td>
</tr>
<tr class="even">
<td align="left">dqsample.int(m, n)</td>
<td align="right">0.00816365</td>
<td align="right">0.01032316</td>
<td align="right">90.04322</td>
<td align="right">6400096</td>
</tr>
</tbody>
</table>
<p>For lower sampling ratios a set based rejection sampling algorithm is
used by dqrng. In principle, R can make use of a similar algorithm based
on a hashset. However, it is only used for larger input vectors even
though it is faster than the default method. The algorithm in dqrng,
which is based on a <a href="https://lemire.me/blog/2012/11/13/fast-sets-of-integers/" class="external-link">bitset</a>,
is even faster, though:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, useHash <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="41%">
<col width="16%">
<col width="16%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n)</td>
<td align="right">1.192838e-03</td>
<td align="right">0.0019367411</td>
<td align="right">433.0223</td>
<td align="right">4042656</td>
</tr>
<tr class="even">
<td align="left">sample.int(m, n, useHash = TRUE)</td>
<td align="right">5.909050e-04</td>
<td align="right">0.0006578130</td>
<td align="right">1427.8970</td>
<td align="right">173720</td>
</tr>
<tr class="odd">
<td align="left">dqsample.int(m, n)</td>
<td align="right">9.965699e-05</td>
<td align="right">0.0001026175</td>
<td align="right">8678.4395</td>
<td align="right">40048</td>
</tr>
</tbody>
</table>
<p>As one decreases the sampling rate even more, dqrng switches to a
hashset based rejection sampling. Both hashset based methods have
similar performance and are much faster than R’s default method.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e2</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, useHash <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="40%">
<col width="16%">
<col width="16%">
<col width="14%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n)</td>
<td align="right">4.788712e-04</td>
<td align="right">6.928451e-04</td>
<td align="right">799.9916</td>
<td align="right">4003056</td>
</tr>
<tr class="even">
<td align="left">sample.int(m, n, useHash = TRUE)</td>
<td align="right">1.463806e-05</td>
<td align="right">1.656706e-05</td>
<td align="right">56302.7572</td>
<td align="right">4072</td>
</tr>
<tr class="odd">
<td align="left">dqsample.int(m, n)</td>
<td align="right">4.761037e-06</td>
<td align="right">5.415990e-06</td>
<td align="right">158618.5998</td>
<td align="right">448</td>
</tr>
</tbody>
</table>
<p>For larger sampling ranges R uses the hashset by default, though
<code>dqsample.int</code> is still faster:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e10</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e5</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n)</td>
<td align="right">0.012448217</td>
<td align="right">0.016431330</td>
<td align="right">58.97732</td>
<td align="right">1851224</td>
</tr>
<tr class="even">
<td align="left">dqsample.int(m, n)</td>
<td align="right">0.001982163</td>
<td align="right">0.003035903</td>
<td align="right">302.74952</td>
<td align="right">800048</td>
</tr>
</tbody>
</table>
<p>The same algorithms but combined with a different selection method
are used to obtain weighted sampling, both with replacement:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">1e6</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e4</span></span>
<span><span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dqrng-functions.html">dqrunif</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="52%">
<col width="13%">
<col width="13%">
<col width="10%">
<col width="10%">
</colgroup>
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n, replace = TRUE, prob = prob)</td>
<td align="right">0.022589995</td>
<td align="right">0.023950481</td>
<td align="right">40.93832</td>
<td align="right">12042696</td>
</tr>
<tr class="even">
<td align="left">dqsample.int(m, n, replace = TRUE, prob = prob)</td>
<td align="right">0.005113458</td>
<td align="right">0.005497366</td>
<td align="right">174.39864</td>
<td align="right">40048</td>
</tr>
</tbody>
</table>
<p>And without replacement:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu">mark</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/dqsample.html">dqsample.int</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span>, prob <span class="op">=</span> <span class="va">prob</span><span class="op">)</span>,</span>
<span>                  check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="40%">
<col width="16%">
<col width="16%">
<col width="15%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">expression</th>
<th align="right">min</th>
<th align="right">median</th>
<th align="right">itr/sec</th>
<th align="right">mem_alloc</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample.int(m, n, prob = prob)</td>
<td align="right">14.504429930</td>
<td align="right">14.504429930</td>
<td align="right">0.0689445</td>
<td align="right">12042696</td>
</tr>
<tr class="even">
<td align="left">dqsample.int(m, n, prob = prob)</td>
<td align="right">0.005157271</td>
<td align="right">0.005645775</td>
<td align="right">171.6651402</td>
<td align="right">40048</td>
</tr>
</tbody>
</table>
<p>Especially for weighted sampling without replacement the performance
advantage compared with R’s default methods is particularly large.</p>
</div>
<div class="section level2">
<h2 id="technicalities">Technicalities<a class="anchor" aria-label="anchor" href="#technicalities"></a>
</h2>
<p>The following methods are used for sampling without replacement. The
algorithms are presented in R-like pseudo code, even though the real
implementation is in C++. For sampling rates above 50%, a partial <a href="https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle" class="external-link">Fisher-Yates
shuffle</a> is used:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">no_replace_shuffle</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">swap</span><span class="op">(</span><span class="va">tmp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">tmp</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fu">random_int</span><span class="op">(</span><span class="va">m</span><span class="op">-</span><span class="va">i</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">tmp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>where <code>random_int(m-i)</code> returns a random integer in
<code>[0, m-i]</code>. Since the full population is kept in memory, this
method is only suitable for high selection rates. One could expect that
<a href="https://en.wikipedia.org/wiki/Reservoir_sampling" class="external-link">reservoir
sampling</a> should work well for lower selection rates. However, in my
tests set based algorithms were faster:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">no_replace_set</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"..."</span>, length <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="co"># integer or numeric</span></span>
<span>  <span class="va">elems</span> <span class="op">&lt;-</span> <span class="fu">new</span><span class="op">(</span><span class="va">set</span>, <span class="va">m</span>, <span class="va">n</span><span class="op">)</span> <span class="co"># set object for storing n objects out of m possible values</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">while</span> <span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">v</span> <span class="op">=</span> <span class="fu">random_int</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">elems.insert</span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">result</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">v</span></span>
<span>        <span class="kw">break</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here <code>elems.insert(v)</code> returns <code>TRUE</code> if the
insert was successful, i.e. <code>v</code> was not in <code>elems</code>
before, and <code>FALSE</code> otherwise. There are different strategies
for implementing such a set. For intermediate sampling rates (currently
between 0.1% and 50%) dqrng uses a bitset, i.e. a vector of
<code>m</code> bits each representing one of the possible values. For
lower sampling rates the memory usage of this algorithm is to expensive,
which is why a hashset<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> is used, since there the used memory scales
with <code>n</code> and not with <code>m</code>. One could expect that
<a href="https://stackoverflow.com/a/2394292/8416610" class="external-link">Robert Floyd’s
sampling algorithm</a> would be superior, but this was not the case in
my tests, probably because it requires a final shuffling of the result
to get a random <em>permutation</em> instead of a random
<em>combination</em>.</p>
<p>So far only un-weighted sampling was considered. However, the same
algorithms can be used for weighted sampling, when
<code>random_int(m)</code>, which uniformly selects one of
<code>m</code> elements, is replaced with a function that selects one of
<code>m</code> elements based on their weights. One such algorithm is <a href="https://doi.org/10.1016/j.physa.2011.12.004" class="external-link">stochastic
acceptance</a>, which is particularly well suited in combination with
fast RNGs:</p>
<blockquote>
<ol style="list-style-type: decimal">
<li>Select randomly one of the individuals (say, <span class="math inline">\(i\)</span>). The selection is done with uniform
probability <span class="math inline">\(1/N\)</span>, which does not
depend on the individual’s fitness <span class="math inline">\(w_i\)</span>.</li>
<li>With probability <span class="math inline">\(w_i/w_\max\)</span>,
where <span class="math inline">\(w_\max = \max\{w_i\}_{i=1}^N\)</span>
is the maximal fitness in the population, the selection is accepted.
Otherwise, the procedure is repeated from step 1 (i.e., in the case of
rejection, another selection attempt is made).</li>
</ol>
</blockquote>
<p>For sampling with replacement the above algorithm can be directly
applied. For sampling without replacement, one might consider updating
<span class="math inline">\(w_\max\)</span> whenever the element with
the maximum weight has been selected. However, this is not necessary
since one can stick to the original <span class="math inline">\(w_\max\)</span> at the cost of a slightly reduced
acceptance rate.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>For the specialists: Open addressing with a power-of-two
size between 1.5 and 3 times <code>n</code>, identity hash function for
the stored integers and quadratic probing.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ralf Stubner.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
