<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel RNG usage â€¢ dqrng</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parallel RNG usage">
<meta property="og:description" content="dqrng">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dqrng</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.2.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dqrng.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cpp-api.html">C++ API</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Parallel RNG usage</a>
    </li>
    <li>
      <a href="../articles/sample.html">Fast sampling methods</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daqana/dqrng/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Parallel RNG usage</h1>
                        <h4 data-toc-skip class="author">Ralf
Stubner</h4>
            
            <h4 data-toc-skip class="date">2024-04-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/daqana/dqrng/blob/HEAD/vignettes/parallel.Rmd" class="external-link"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="hidden name"><code>parallel.Rmd</code></div>

    </div>

    
    
<p>When you want to use random number generators (RNG) for parallel
computations, you need to make sure that the sequences of random numbers
used by the different processes do not overlap. There are two main
approaches to this problem:<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<ul>
<li>Partition the complete sequence of random numbers produced for one
seed into non-overlapping sequences and assign each process one
sub-sequence.</li>
<li>Re-parametrize the generator to produce independent sequences for
the same seed.</li>
</ul>
<p>The RNGs included in <code>dqrng</code> offer at least one of these
methods for parallel RNG usage. When using the R or C++ interface
independent streams can be accessed using the two argument
<code>dqset.seed(seed, stream)</code> or
<code>dqset_seed(seed, stream)</code> functions.</p>
<div class="section level2">
<h2 id="threefry-usage-from-r">Threefry: usage from R<a class="anchor" aria-label="anchor" href="#threefry-usage-from-r"></a>
</h2>
<p>The Threefry engine uses internally a counter with <span class="math inline">\(2^{256}\)</span> possible states, which can be
split into different substreams. When used from R or C++ with the two
argument <code>dqset.seed</code> or <code>dqset_seed</code> this counter
space is split into <span class="math inline">\(2^{64}\)</span> streams
with <span class="math inline">\(2^{192}\)</span> possible states each.
This is equivalent to <span class="math inline">\(2^{64}\)</span>
streams with a period of <span class="math inline">\(2^{194}\)</span>
each.</p>
<p>In the following example a matrix with random numbers is generated in
parallel using the parallel package. The resulting correlation matrix
should be close to the identity matrix if the different streams are
independent:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterApply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, <span class="kw">function</span><span class="op">(</span><span class="va">stream</span>, <span class="va">seed</span>, <span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://daqana.github.io/dqrng/" class="external-link">dqrng</a></span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dqrng-functions.html">dqRNGkind</a></span><span class="op">(</span><span class="st">"Threefry"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dqrng-functions.html">dqset.seed</a></span><span class="op">(</span><span class="va">seed</span>, <span class="va">stream</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dqrng-functions.html">dqrnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="fl">42</span>, <span class="fl">1e6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/symnum.html" class="external-link">symnum</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, cutpoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.003</span>, <span class="fl">0.999</span><span class="op">)</span>,</span>
<span>       symbols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">"?"</span>, <span class="st">"!"</span>, <span class="st">"1"</span><span class="op">)</span>,</span>
<span>       abbr.colnames <span class="op">=</span> <span class="cn">FALSE</span>, corr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Correlation matrix:</p>
<pre><code>[1,] 1              
[2,]   1            
[3,]   ? 1          
[4,]   ? ? 1        
[5,] ?     ? 1      
[6,]     ?     1    
[7,]     ?       1  
[8,]         ?     1
attr(,"legend")
[1] 0 â€˜ â€™ 0.001 â€˜?â€™ 0.003 â€˜!â€™ 0.999 â€˜1â€™ 1</code></pre>
<p>As expected the correlation matrix for the different columns is
almost equal to the identity matrix.</p>
</div>
<div class="section level2">
<h2 id="xoroshiro-jump-ahead-with-openmp">Xo(ro)shiro: jump ahead with OpenMP<a class="anchor" aria-label="anchor" href="#xoroshiro-jump-ahead-with-openmp"></a>
</h2>
<p>The Xoshiro256+/++/** generators has a period of <span class="math inline">\(2^{256} -1\)</span> and offers <span class="math inline">\(2^{128}\)</span> sub-sequences that are <span class="math inline">\(2^{128}\)</span> random draws apart as well as
<span class="math inline">\(2^{64}\)</span> streams that are <span class="math inline">\(2^{192}\)</span> random draws apart. The
Xoroshiro128+/++/** generators has a period of <span class="math inline">\(2^{128} -1\)</span> and offers <span class="math inline">\(2^{64}\)</span> sub-sequences that are <span class="math inline">\(2^{64}\)</span> random draws apart as well as
<span class="math inline">\(2^{32}\)</span> streams that are <span class="math inline">\(2^{98}\)</span> random draws apart. You can go
from one sub-sequence to the next using the <code>jump()</code> or
<code>long_jump()</code> method and the convenience wrapper
<code>jump(int n)</code> or <code>long_jump(int n)</code>, which
advances to the <code>n</code>th sub-sequence. When used from R or C++
with the two argument <code>dqset.seed</code> and
<code>dqset_seed</code> you get <span class="math inline">\(2^{64}\)</span> streams that are <span class="math inline">\(2^{192}\)</span> and <span class="math inline">\(2^{64}\)</span> random draws apart for
Xoshiro256+/++/** and Xoroshiro128+/++/**, respectively.</p>
<p>As an example using C++ we draw and sum a large number of uniformly
distributed numbers. This is done several times sequentially as well as
using OpenMP for parallelisation. Care has been taken to keep the global
RNG <code>rng</code> usable outside of the parallel block.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(dqrng, BH)]]</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;xoshiro.h&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng_distribution.h&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(openmp)]]</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> random_sum<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  dqrng<span class="op">::</span>uniform_distribution dist<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span> <span class="co">// Uniform distribution [0,1)</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  dqrng<span class="op">::</span>xoshiro256plus rng<span class="op">(</span><span class="dv">42</span><span class="op">);</span>              <span class="co">// properly seeded rng</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> res<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>    <span class="dt">double</span> lres<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>      lres <span class="op">+=</span> dist<span class="op">(</span>rng<span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>    res<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> lres <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> parallel_random_sum<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> m<span class="op">,</span> <span class="dt">int</span> ncores<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>  dqrng<span class="op">::</span>uniform_distribution dist<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span> <span class="co">// Uniform distribution [0,1)</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>  dqrng<span class="op">::</span>xoshiro256plusplus rng<span class="op">(</span><span class="dv">42</span><span class="op">);</span>          <span class="co">// properly seeded rng</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> res<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="co">// ok to use rng here</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  </span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  <span class="pp">#pragma omp parallel num_threads(ncores)</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>    dqrng<span class="op">::</span>xoshiro256plusplus lrng<span class="op">(</span>rng<span class="op">);</span>      <span class="co">// make thread local copy of rng </span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>    lrng<span class="op">.</span>long_jump<span class="op">(</span>omp_get_thread_num<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// advance rng by 1 ... ncores jumps</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>    <span class="pp">#pragma omp for</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>      <span class="dt">double</span> lres<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>        lres <span class="op">+=</span> dist<span class="op">(</span>lrng<span class="op">);</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>      res<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> lres <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>  <span class="co">// ok to use rng here</span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a><span class="co">bm &lt;- bench::mark(</span></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a><span class="co">  parallel_random_sum(1e7, 8, 4),</span></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a><span class="co">  random_sum(1e7, 8),</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="co">  check = FALSE</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a><span class="co">bm[,1:4]</span></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>Result:</p>
<pre><code>  expression                            min   median `itr/sec`
  &lt;bch:expr&gt;                       &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt;
1 parallel_random_sum(1e+07, 8, 4)   98.3ms     99ms     10.1 
2 random_sum(1e+07, 8)              270.2ms    271ms      3.68</code></pre>
<p>In the previous example it was necessary to create our own RNG
object. It would be nice if it were possible to use dqrngâ€™s global RNG
instead. To showcase this, we implement the same procedure as before,
but this time make use of <code>dqrng::random_64bit_accessor</code> to
access the global RNG and its <code>clone(stream)</code> method that
creates a cloned version with a different stream:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(dqrng, BH)]]</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng.h&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng_distribution.h&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(openmp)]]</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;omp.h&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> random_sum<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> m<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  dqrng<span class="op">::</span>uniform_distribution dist<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span> <span class="co">// Uniform distribution [0,1)</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  <span class="kw">auto</span> rng <span class="op">=</span> dqrng<span class="op">::</span>random_64bit_accessor<span class="op">{};</span>  <span class="co">// properly seeded rng</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> res<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    <span class="dt">double</span> lres<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>      lres <span class="op">+=</span> dist<span class="op">(</span>rng<span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    res<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> lres <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> parallel_random_sum<span class="op">(</span><span class="dt">int</span> n<span class="op">,</span> <span class="dt">int</span> m<span class="op">,</span> <span class="dt">int</span> ncores<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  dqrng<span class="op">::</span>uniform_distribution dist<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">);</span> <span class="co">// Uniform distribution [0,1)</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>  <span class="kw">auto</span> rng <span class="op">=</span> dqrng<span class="op">::</span>random_64bit_accessor<span class="op">{};</span>  <span class="co">// properly seeded rng</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> res<span class="op">(</span>m<span class="op">);</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="co">// ok to use rng here</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="pp">#pragma omp parallel num_threads(ncores)</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  <span class="co">// make thread local copy of rng and advance it by 1 ... ncores jumps</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  <span class="kw">auto</span> lrng <span class="op">=</span> rng<span class="op">.</span>clone<span class="op">(</span>omp_get_thread_num<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span>      </span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="pp">#pragma omp for</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> m<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>    <span class="dt">double</span> lres<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>      lres <span class="op">+=</span> dist<span class="op">(*</span>lrng<span class="op">);</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>    res<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> lres <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a><span class="co">// ok to use rng here</span></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a><span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a><span class="co">bm &lt;- bench::mark(</span></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a><span class="co">  parallel_random_sum(1e7, 8, 4),</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a><span class="co">  random_sum(1e7, 8),</span></span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a><span class="co">  check = FALSE</span></span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a><span class="co">)</span></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a><span class="co">bm[,1:4]</span></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>Notes that the thread local RNG uses <code>std::unique_ptr</code>
instead of <code>Rcpp::Xptr</code> since it is used in parallel
code.</p>
</div>
<div class="section level2">
<h2 id="pcg-multiple-streams-with-rcppparallel">PCG: multiple streams with RcppParallel<a class="anchor" aria-label="anchor" href="#pcg-multiple-streams-with-rcppparallel"></a>
</h2>
<p>From the PCG family we will look at pcg64, a 64-bit generator with a
period of <span class="math inline">\(2^{128}\)</span>. It offers the
function <a href="https://www.pcg-random.org/using-pcg-cpp.html#void-advance-state-type-delta" class="external-link"><code>advance(int n)</code></a>,
which is equivalent to <code>n</code> random draws but scales as <span class="math inline">\(O(ln(n))\)</span> instead of <span class="math inline">\(O(n)\)</span>. In addition, it offers <span class="math inline">\(2^{127}\)</span> separate streams that can be
enabled via the function <a href="https://www.pcg-random.org/using-pcg-cpp.html#void-pcg32-set-stream-state-type-stream" class="external-link"><code>set_stream(int n)</code></a>
or the <a href="https://www.pcg-random.org/using-pcg-cpp.html#pcg32-pcg32-constructor" class="external-link">two
argument constructor</a> with <code>seed</code> and <code>stream</code>.
When used from R or C++ with the two argument <code>dqset.seed</code>
and <code>dqset_seed</code> you get <span class="math inline">\(2^{64}\)</span> streams out of the possible <span class="math inline">\(2^{127}\)</span> separate streams.</p>
<p>In the following example a matrix with random numbers is generated in
parallel using RcppParallel. Instead of using the more traditional
approach of generating the random numbers from a certain distribution,
we are using the fast sampling methods from <code>dqrng_sample.h</code>.
As a consequence, we cannot use <code>pcg64</code> directly but have to
wrap it as <code>dqrng::generator</code>. The resulting correlation
matrix should be close to the identity matrix if the different streams
are independent:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(dqrng, BH)]]</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng_generator.h&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng_sample.h&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="kw">struct</span> RandomFill <span class="op">:</span> <span class="kw">public</span> RcppParallel<span class="op">::</span>Worker <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  RcppParallel<span class="op">::</span>RMatrix<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> output<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  <span class="dt">uint64_t</span> seed<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  RandomFill<span class="op">(</span>Rcpp<span class="op">::</span>IntegerMatrix output<span class="op">,</span> <span class="at">const</span> <span class="dt">uint64_t</span> seed<span class="op">)</span> <span class="op">:</span> output<span class="op">(</span>output<span class="op">),</span> seed<span class="op">(</span>seed<span class="op">)</span> <span class="op">{};</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="bu">std::</span>size_t begin<span class="op">,</span> <span class="bu">std::</span>size_t end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="kw">auto</span> rng <span class="op">=</span> dqrng<span class="op">::</span>generator<span class="op">&lt;</span>pcg64<span class="op">&gt;(</span>seed<span class="op">,</span> end<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t col <span class="op">=</span> begin<span class="op">;</span> col <span class="op">&lt;</span> end<span class="op">;</span> <span class="op">++</span>col<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>      <span class="kw">auto</span> sampled <span class="op">=</span> dqrng<span class="op">::</span>sample<span class="op">::</span>sample<span class="op">&lt;</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;,</span> <span class="dt">uint32_t</span><span class="op">&gt;(*</span>rng<span class="op">,</span> <span class="dv">100000</span><span class="op">,</span> output<span class="op">.</span>nrow<span class="op">(),</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>      RcppParallel<span class="op">::</span>RMatrix<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;::</span>Column column <span class="op">=</span> output<span class="op">.</span>column<span class="op">(</span>col<span class="op">);</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>      <span class="bu">std::</span>copy<span class="op">(</span>sampled<span class="op">.</span>begin<span class="op">(),</span> sampled<span class="op">.</span>end<span class="op">(),</span> column<span class="op">.</span>begin<span class="op">());</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>Rcpp<span class="op">::</span>IntegerMatrix parallel_random_matrix<span class="op">(</span><span class="at">const</span> <span class="dt">int</span> n<span class="op">,</span> <span class="at">const</span> <span class="dt">int</span> m<span class="op">,</span> <span class="at">const</span> <span class="dt">int</span> ncores<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>  Rcpp<span class="op">::</span>IntegerMatrix res<span class="op">(</span>n<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>  RandomFill randomFill<span class="op">(</span>res<span class="op">,</span> <span class="dv">42</span><span class="op">);</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>  RcppParallel<span class="op">::</span>parallelFor<span class="op">(</span><span class="dv">0</span><span class="op">,</span> m<span class="op">,</span> randomFill<span class="op">,</span> m<span class="op">/</span>ncores <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a><span class="co">res &lt;- parallel_random_matrix(1e6, 8, 4)</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="co">head(res)</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="co">symnum(x = cor(res), cutpoints = c(0.001, 0.003, 0.999),</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="co">       symbols = c(" ", "?", "!", "1"),</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a><span class="co">       abbr.colnames = FALSE, corr = TRUE)</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<p>Head of the random matrix:</p>
<pre><code>      [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
[1,] 16144 89512 16144 53103 16144 41760 16144 99788
[2,] 21200 86552 21199 38327 21198 90293 21198 45713
[3,]   124 60045 97553 79574 99977 84423 87126 35715
[4,]  6590 93044 18536 98945 66969 53338 38426 53560
[5,] 80618 42051 15815 79380 71590 98006 87220 63036
[6,] 49954 90168 12614 32488 54145 68029 34733 48989</code></pre>
<p>Correlation matrix:</p>
<pre><code>[1,] 1              
[2,]   1            
[3,] ?   1          
[4,]   ?   1        
[5,]     ? ? 1      
[6,]   ?       1    
[7,] ?           1  
[8,]       ?     ? 1
attr(,"legend")
[1] 0 â€˜ â€™ 0.001 â€˜?â€™ 0.003 â€˜!â€™ 0.999 â€˜1â€™ 1</code></pre>
<p>So as expected the correlation matrix is almost equal to the identity
matrix.</p>
<p>As in the previous section, we can again switch from seeding our own
RNG to starting from the global RNG and selecting separate substreams
from there. RNG selection and seeding can then be handled from R:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">// [[Rcpp::depends(dqrng, BH)]]</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng.h&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dqrng_sample.h&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">// [[Rcpp::plugins(cpp11)]]</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co">// [[Rcpp::depends(RcppParallel)]]</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;RcppParallel.h&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="kw">struct</span> RandomFill <span class="op">:</span> <span class="kw">public</span> RcppParallel<span class="op">::</span>Worker <span class="op">{</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  RcppParallel<span class="op">::</span>RMatrix<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> output<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  dqrng<span class="op">::</span>random_64bit_accessor rng<span class="op">{};</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  RandomFill<span class="op">(</span>Rcpp<span class="op">::</span>IntegerMatrix output<span class="op">)</span> <span class="op">:</span> output<span class="op">(</span>output<span class="op">)</span> <span class="op">{};</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="dt">void</span> <span class="kw">operator</span><span class="op">()(</span><span class="bu">std::</span>size_t begin<span class="op">,</span> <span class="bu">std::</span>size_t end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="kw">auto</span> lrng <span class="op">=</span> rng<span class="op">.</span>clone<span class="op">(</span>end<span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t col <span class="op">=</span> begin<span class="op">;</span> col <span class="op">&lt;</span> end<span class="op">;</span> <span class="op">++</span>col<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>      <span class="kw">auto</span> sampled <span class="op">=</span> dqrng<span class="op">::</span>sample<span class="op">::</span>sample<span class="op">&lt;</span><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;,</span> <span class="dt">uint32_t</span><span class="op">&gt;(*</span>lrng<span class="op">,</span> <span class="dv">100000</span><span class="op">,</span> output<span class="op">.</span>nrow<span class="op">(),</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>      RcppParallel<span class="op">::</span>RMatrix<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;::</span>Column column <span class="op">=</span> output<span class="op">.</span>column<span class="op">(</span>col<span class="op">);</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>      <span class="bu">std::</span>copy<span class="op">(</span>sampled<span class="op">.</span>begin<span class="op">(),</span> sampled<span class="op">.</span>end<span class="op">(),</span> column<span class="op">.</span>begin<span class="op">());</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>Rcpp<span class="op">::</span>IntegerMatrix parallel_random_matrix<span class="op">(</span><span class="at">const</span> <span class="dt">int</span> n<span class="op">,</span> <span class="at">const</span> <span class="dt">int</span> m<span class="op">,</span> <span class="at">const</span> <span class="dt">int</span> ncores<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  Rcpp<span class="op">::</span>IntegerMatrix res<span class="op">(</span>n<span class="op">,</span> m<span class="op">);</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>  RandomFill randomFill<span class="op">(</span>res<span class="op">);</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>  RcppParallel<span class="op">::</span>parallelFor<span class="op">(</span><span class="dv">0</span><span class="op">,</span> m<span class="op">,</span> randomFill<span class="op">,</span> m<span class="op">/</span>ncores <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a><span class="co">/*** R</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co">dqRNGkind("pcg64")</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a><span class="co">dqset.seed(42)</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co">res &lt;- parallel_random_matrix(1e6, 8, 4)</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="co">head(res)</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a><span class="co">symnum(x = cor(res), cutpoints = c(0.001, 0.003, 0.999),</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">       symbols = c(" ", "?", "!", "1"),</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a><span class="co">       abbr.colnames = FALSE, corr = TRUE)</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>See for example <a href="https://www.pcg-random.org/posts/critiquing-pcg-streams.html" class="external-link uri">https://www.pcg-random.org/posts/critiquing-pcg-streams.html</a>.<a href="#fnref1" class="footnote-back">â†©ï¸Ž</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ralf Stubner.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
